-- üéµ CRIA√á√ÉO DA TABELA SPOTIFY_TOKENS
-- Execute este SQL no Dashboard Supabase > SQL Editor

-- 1. Criar a tabela spotify_tokens
CREATE TABLE IF NOT EXISTS spotify_tokens (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    access_token TEXT NOT NULL,
    refresh_token TEXT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Garantir que cada usu√°rio tenha apenas um registro
    UNIQUE(user_id)
);

-- 2. Habilitar RLS (Row Level Security)
ALTER TABLE spotify_tokens ENABLE ROW LEVEL SECURITY;

-- 3. Pol√≠tica para permitir usu√°rios verem apenas seus pr√≥prios tokens
CREATE POLICY "Usu√°rios podem ver apenas seus pr√≥prios tokens Spotify"
ON spotify_tokens FOR SELECT
USING (auth.uid() = user_id);

-- 4. Pol√≠tica para permitir usu√°rios inserirem seus pr√≥prios tokens
CREATE POLICY "Usu√°rios podem inserir seus pr√≥prios tokens Spotify"
ON spotify_tokens FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- 5. Pol√≠tica para permitir usu√°rios atualizarem seus pr√≥prios tokens
CREATE POLICY "Usu√°rios podem atualizar seus pr√≥prios tokens Spotify"
ON spotify_tokens FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- 6. Pol√≠tica para permitir usu√°rios deletarem seus pr√≥prios tokens
CREATE POLICY "Usu√°rios podem deletar seus pr√≥prios tokens Spotify"
ON spotify_tokens FOR DELETE
USING (auth.uid() = user_id);

-- 7. Pol√≠tica especial para a service role (necess√°ria para a Edge Function)
CREATE POLICY "Service role pode gerenciar todos os tokens"
ON spotify_tokens FOR ALL
USING (current_setting('role') = 'service_role')
WITH CHECK (current_setting('role') = 'service_role');

-- 8. Criar √≠ndice para melhor performance
CREATE INDEX IF NOT EXISTS idx_spotify_tokens_user_id ON spotify_tokens(user_id);
CREATE INDEX IF NOT EXISTS idx_spotify_tokens_expires_at ON spotify_tokens(expires_at);

-- ‚úÖ PRONTO! Tabela criada com todas as pol√≠ticas necess√°rias
